import { implement } from "@orpc/server";
import { autoAuthMiddleware, type RpcContext } from "@checkmate/backend-api";
import { {{pluginNameCamel}}Contract } from "@checkmate/{{pluginBaseName}}-common";
import type { NodePgDatabase } from "drizzle-orm/node-postgres";
import type * as schema from "./schema";
import { {{pluginNamePascal}}Service } from "./service";

/**
 * Creates the {{pluginBaseName}} router using contract-based implementation.
 *
 * Auth and permissions are automatically enforced via autoAuthMiddleware
 * based on the contract's meta.userType and meta.permissions.
 */
const os = implement({{pluginNameCamel}}Contract)
  .$context<RpcContext>()
  .use(autoAuthMiddleware);

export function create{{pluginNamePascal}}Router({
  database,
}: {
  database: NodePgDatabase<typeof schema>;
}) {
  const service = new {{pluginNamePascal}}Service(database);

  return os.router({
    getItems: os.getItems.handler(async () => {
      return await service.getItems();
    }),

    getItem: os.getItem.handler(async ({ input }) => {
      return await service.getItem(input);
    }),

    createItem: os.createItem.handler(async ({ input }) => {
      return await service.createItem(input);
    }),

    updateItem: os.updateItem.handler(async ({ input }) => {
      return await service.updateItem(input.id, input.data);
    }),

    deleteItem: os.deleteItem.handler(async ({ input }) => {
      await service.deleteItem(input);
    }),
  });
}
